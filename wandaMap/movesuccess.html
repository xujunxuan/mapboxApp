<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>易得路位置信息查看系统</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.0/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.js' charset=”utf-8″></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.css' rel='stylesheet' />
    <link href='css/style.css'  rel='stylesheet' charset="utf-8"/>
</head>
<body>

<div id='map'></div>
<!-- <ul id="buttons">
    <li id='button-fr' class='button'>点击</li>
</ul> -->

<ul id="tags" class="tagbar abs">

</ul>

<script>
var mapinfo={};
mapinfo[0]={
    container: 'map', // container id
    style: 'mapbox://styles/ezroad/cj6rj02se4ian2qr0csjn0hnq', // stylesheet location
    center: [114.35024410486221, 30.528976379032812], // starting position [lng, lat]
    zoom: 19, // starting zoom
    bearing: -30,
    hash: false,
    pitch: 60
}
mapinfo[1]={
    container: 'map', // container id
    style: 'mapbox://styles/ezroad/cj9lbq3t71hgf2rqfo0bopwey',  // stylesheet location
    center: [114.35024410486221, 30.528976379032812], // starting position [lng, lat]
    zoom: 19, // starting zoom
    bearing: -30,
    hash: false,
    pitch: 60
}
mapinfo[2]={
    container: 'map', // container id
    style: 'mapbox://styles/ezroad/cj6rj02se4ian2qr0csjn0hnq', // stylesheet location
    center: [114.35024410486221, 30.528976379032812], // starting position [lng, lat]
    zoom: 19, // starting zoom
    bearing: -30,
    hash: false,
    pitch: 60
}

var mapname={}
mapname[0]="1 F";
mapname[1]="2 F";
mapname[2]="3 F";

for(var i in mapname){
    $("#tags").prepend('<li><button type="button" class="btn btn-default" fnum="'+i+'">'+mapname[i]+'</button></li>');
}

$("button[fnum]").click(function(){
    var mapId=$(this).attr("fnum");
    console.info(mapId);
    changeMap(mapId);
    console.info("||"+mapId);
})


mapboxgl.accessToken = 'pk.eyJ1IjoiZXpyb2FkIiwiYSI6ImNqNjc1NHc3czAxcHYyeHJ5dnE3c21xM2oifQ.HxJTd0na3DENxYr2rGXfWw';
//读取到的坐标
var x = 114.35024410486221;
var y = 30.528886379032810;
//初始位置
var x1 = 114.35024410486221;
var y1 = 30.528976379032812;

var posStack=[];
//var pos={timestamp:"",x:"",y:""}
//默认从map1开始
var hnow=0;
var map = new mapboxgl.Map(mapinfo[hnow]);
//时间戳
var _TIMESTAMP=null;

$('button[fnum="'+ hnow +'"]').addClass('active');

//轮询请求最新点信息
function polling(cb,ts){
        $.ajax({
           type: "GET",
           url: "backend/infolite.php",
           success: function(data){
            // Added By Pinckney
            var arr= JSON.parse(data);
            for(var i= 0;i<arr.length;i++){
                let obj=arr[i];
                // if (y!= arr[i].lat || x != arr[i].lon){
                	//console.log(x1+"||"+y1);
                    x1 = x;
                    y1 = y;
                    y = arr[i].lat;
                    x = arr[i].lon;
                    cb(arr[i].h);
                // }
             console.info("x"+arr[i].lat+"||y"+arr[i].lon);
            }
           }
        });
}

function pointMove(x,y) {
       return {
        "type": "Point",
        "coordinates": [
           x,
           y
        ]
    };
}

map.on('load', function () {
    // Add a source and layer displaying a point which will be animated in a circle.
    console.log("on load");
    map.addSource('point', {
        "type": "geojson",
        "data": pointMove(114.35024410486221,30.528976379032812)
    });

    map.addLayer({
        "id": "point",
        "source": "point",
        "type": "circle",
        "paint": {
            "circle-radius": 10,
            "circle-color": "#007cbf"
        }
    });

    //用于去除timestamp第二个值随机很大的bug
    var flag = 0;
    var timestamptemp = 0;


    function animateMarker(h) {
        // Update the data to a new position based on the animation timestamp. The
        // divisor in the expression `timestamp / 1000` controls the animation speed.
        var timestamp = new Date().getTime();



        // if(h!=hnow&&mapinfo[h]!=undefined){
        //     changeMap(h);
        // }
        if(map.getSource('point')!=undefined){
            map.getSource('point').setData(pointMove(x,y));            
        }
        else{
            if(map!=undefined){
                map.addSource('point', {
                    "type": "geojson",
                    "data": pointMove(x,y)
                });

                map.addLayer({
                    "id": "point",
                    "source": "point",
                    "type": "circle",
                    "paint": {
                        "circle-radius": 10,
                        "circle-color": "#007cbf"
                    }
                });                
            }
            else{
                console.warn("Map is not defined")
            }

        }
        

        // Request the next frame of the animation.
        //requestAnimationFrame(animateMarker);

    }

    var timer = setInterval(function(){
        polling(animateMarker);
    },1100);//polling interval>1.03s

});





// var changeMap=function(n){
//     map = new mapboxgl.Map(mapinfo[n]);
//     x=null;
//     y=null;
// }
function changeMap(n){
    $("#map").html("");
    map = new mapboxgl.Map(mapinfo[n]);
    x=null;
    y=null;
    hnow=n;
    $('button[fnum]').removeClass('active');
    $('button[fnum="'+ n +'"]').addClass('active');
}
</script>

</body>
</html>