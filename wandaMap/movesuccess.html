<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>易得路位置信息查看系统</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.0/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.js' charset=”utf-8″></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.css' rel='stylesheet' />
    <link href='css/style.css'  rel='stylesheet' charset="utf-8"/>
</head>
<body>

<div id='map'></div>

<ul id="tags" class="tagbar abs">

</ul>

<script>
var mapinfo={};
mapinfo[0]={
    container: 'map', // container id
    style: 'mapbox://styles/ezroad/cj6rj02se4ian2qr0csjn0hnq', // stylesheet location
    center: [114.35024410486221, 30.528976379032812], // starting position [lng, lat]
    zoom: 19, // starting zoom
    bearing: -30,
    hash: false,
    pitch: 60
}
mapinfo[1]={
    container: 'map', // container id
    style: 'mapbox://styles/ezroad/cj9lbq3t71hgf2rqfo0bopwey',  // stylesheet location
    center: [114.35024410486221, 30.528976379032812], // starting position [lng, lat]
    zoom: 19, // starting zoom
    bearing: -30,
    hash: false,
    pitch: 60
}
mapinfo[2]={
    container: 'map', // container id
    style: 'mapbox://styles/ezroad/cj6rj02se4ian2qr0csjn0hnq', // stylesheet location
    center: [114.35024410486221, 30.528976379032812], // starting position [lng, lat]
    zoom: 19, // starting zoom
    bearing: -30,
    hash: false,
    pitch: 60
}

var mapname={}
mapname[0]="1 F";
mapname[1]="2 F";
mapname[2]="3 F";

for(var i in mapname){
    $("#tags").prepend('<li><button type="button" class="btn btn-default" fnum="'+i+'">'+mapname[i]+'</button></li>');
}

$("button[fnum]").click(function(){
    var mapId=$(this).attr("fnum");
    changeMap(mapId);
})


mapboxgl.accessToken = 'pk.eyJ1IjoiZXpyb2FkIiwiYSI6ImNqNjc1NHc3czAxcHYyeHJ5dnE3c21xM2oifQ.HxJTd0na3DENxYr2rGXfWw';
//读取到的坐标
var x = 114.35024410486221;
var y = 30.528886379032810;
//初始位置
var x1 = 114.35024410486221;
var y1 = 30.528976379032812;

var posStack=[];
//var pos={timestamp:"",x:"",y:""}
//默认从map1开始
var hnow=0;
var map = new mapboxgl.Map(mapinfo[hnow]);
//时间戳
var _TIMESTAMP=null;

$('button[fnum="'+ hnow +'"]').addClass('active');

//轮询请求最新点信息
function polling(cb){
        $.ajax({
            type: "GET",
            url: "backend/infolite.php",
            success: function(data){
            // Added By Pinckney
                var arr= JSON.parse(data);
                if(typeof(cb)!='string'){
                    cb(arr);
                }
            }
        });
}

function pointMove(x,y) {
       return {
        "type": "Point",
        "coordinates": [
           x,
           y
        ]
    };
}

map.on('load', function () {
    // Add a source and layer displaying a point which will be animated in a circle.
    console.log("on load");

    pandlInit();

    //用于去除timestamp第二个值随机很大的bug
    /*
    var flag = 0;
    var timestamptemp = 0;


    function animateMarker(h) {
        // Update the data to a new position based on the animation timestamp. The
        // divisor in the expression `timestamp / 1000` controls the animation speed.
        var timestamp = new Date().getTime();


        //自动切换楼层，多点时去掉
        // if(h!=hnow&&mapinfo[h]!=undefined){
        //     changeMap(h);
        // }

    }
    */
    var timer = setInterval(function(){
        polling(updatePoints);
    },1100);//polling interval>1.03s

});


function changeMap(n){
    $("#map").html("");
    map = new mapboxgl.Map(mapinfo[n]);
    x=null;
    y=null;
    hnow=n;
    $('button[fnum]').removeClass('active');
    $('button[fnum="'+ n +'"]').addClass('active');
}


var myjson={
            "type": "geojson",
            "data": {
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.35024410486221,30.528976379032812]
                    },
                    "properties": {
                        "title": "Client 1"
                    }
                }, {
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [114.35003,30.5289]
                    },
                    "properties": {
                        "title": "Client 2"
                    }
                }]
            }
        }

var updatePoints=function(arr){
    if(map.getSource('labels')!=undefined){
        map.getSource('labels').setData(featureJson(arr).data);            
    }
    else{
        if(map!=undefined){
            map.addSource('labels', featureJson);
            map.addLayer({
                "id": "labels",
                "type": "symbol",
                "source": "labels",
                "layout": {
                    "text-field": "{title}",
                    "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
                    "text-offset": [0, 0.6],
                    "text-anchor": "top"
                }
            });                
        }
        else{
            console.warn("Map is not defined")
        }
    }
    for(var i=0;i<arr.length;i++){
        pandlMove(arr[i]);
    }

}

var pandlMove=function(obj){
    if(obj["name"]!=undefined){
        if(map.getSource('point'+obj["name"])!=undefined){
            map.getSource('point'+obj["name"]).setData(pointMove(x,y));            
        }
        else{
            if(map!=undefined){
                map.addSource('point'+obj["name"], {
                    "type": "geojson",
                    "data": pointMove(x,y)
                });

                map.addLayer({
                    "id": "point"+obj["name"],
                    "source": "point"+obj["name"],
                    "type": "circle",
                    "paint": {
                        "circle-radius": 10,
                        "circle-color": "#007cbf"
                    }
                });                
            }
            else{
                console.warn("Map is not defined")
            }
        }
    }
}

var pandlInit=function(){
    // map.addSource('point', {
    //     "type": "geojson",
    //     "data": pointMove(114.35024410486221,30.528976379032812)
    // });

    // map.addLayer({
    //     "id": "point",
    //     "source": "point",
    //     "type": "circle",
    //     "paint": {
    //         "circle-radius": 10,
    //         "circle-color": "#007cbf"
    //     }
    // });
    pandlMove(114.35024410486221,30.528976379032812);
    pandlMove((114.35020410486221,30.528876379032812))
    map.addSource('labels', myjson);
    map.addLayer({
        "id": "labels",
        "type": "symbol",
        "source": "labels",
        "layout": {
            "text-field": "{title}",
            "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
            "text-offset": [0, 0.6],
            "text-anchor": "top"
        }
    });
}

var featureJson=function(arr){
    return {
            "type": "geojson",
            "data": {
                "type": "FeatureCollection",
                "features": jsonToLabels(arr)
            }
        }
}

var jsonToLabels=function(arr){
    var tmpJson=myjson.data;
    var tempFeatures=[];
    for(var i= 0;i<arr.length;i++){
        var obj=arr[i];
        var tmpfObj={
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [0,0]
            },
            "properties": {
                "title": "Client"
            }
        }
        var xyarr=[];
        xyarr.push(obj.lat);
        xyarr.push(obj.lon);
        tmpfObj["geometry"]["coordinates"]=xyarr;
        tmpfObj["properties"]["title"]="Client"+obj.name
        tempFeatures.push(tmpfObj)

    }
    console.info(tempFeatures);
    return tempFeatures;
}

var jsonToPoints=function(arr){

}
</script>

</body>
</html>