<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>易得路位置信息查看系统</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.0/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.js' charset=”utf-8″></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.29.0/mapbox-gl.css' rel='stylesheet' />
    <link href='css/style.css'  rel='stylesheet' charset="utf-8"/>
</head>
<body>

<div id='map'></div>
<ul id="buttons">
    <li id='button-fr' class='button'>点击</li>
</ul>

<script>
var mapinfo={};
mapinfo[1]={
    container: 'map', // container id
    style: 'mapbox://styles/ezroad/cj9cpr26b5glr2sp83gvzitgz', // stylesheet location
    center: [119.671206, 29.092635], // starting position [lng, lat]
    zoom: 19, // starting zoom
    bearing: -30,
    hash: false,
    pitch: 60
}
mapinfo[2]={
    container: 'map', // container id
    style: 'mapbox://styles/ezroad/cj9csxk1p5jvz2spikir9plox', // stylesheet location
    center: [119.671533, 29.092709], // starting position [lng, lat]
    zoom: 19, // starting zoom
    bearing: -30,
    hash: false,
    pitch: 60
}
mapinfo[3]={
    container: 'map', // container id
    style: 'mapbox://styles/ezroad/cj9dld9f06b1f2ro3p5f87oli', // stylesheet location
    center: [119.671130, 29.092542], // starting position [lng, lat]
    zoom: 19, // starting zoom
    bearing: -30,
    hash: false,
    pitch: 60
}


mapboxgl.accessToken = 'pk.eyJ1IjoiZXpyb2FkIiwiYSI6ImNqNjc1NHc3czAxcHYyeHJ5dnE3c21xM2oifQ.HxJTd0na3DENxYr2rGXfWw';
//读取到的坐标
var x = 119.671349;
var y = 29.092620;
//初始位置
var x1 = 119.671206;
var y1 = 29.092635

var map = new mapboxgl.Map(mapinfo[1]);


//读取txt文件
function polling(cb){
        $.ajax({
           type: "GET",
           url: "backend/infolite.php",
           success: function(data){
            // Added By Pinckney
            var arr= JSON.parse(data);
            for(var i= 0;i<arr.length;i++){
                let obj=arr[i];
                if (y!= arr[i].lat || x != arr[i].lon){
                		console.log(x1+"||"+y1);
                    x1 = x;
                    y1 = y;
                    y = arr[i].lat;
                    x = arr[i].lon;
                    cb(0);
                }
             console.info("x"+arr[i].lat+"||y"+arr[i].lon);
            }
           }
        });
}

function pointMove(x,y) {
       return {
        "type": "Point",
        "coordinates": [
           x,
           y
        ]
    };
}

map.on('load', function () {
    // Add a source and layer displaying a point which will be animated in a circle.
    console.log("on load");
    map.addSource('point', {
        "type": "geojson",
        "data": pointMove(119.671206,29.092635)
    });

    map.addLayer({
        "id": "point",
        "source": "point",
        "type": "circle",
        "paint": {
            "circle-radius": 10,
            "circle-color": "#007cbf"
        }
    });

    //用于去除timestamp第二个值随机很大的bug
    var flag = 0;
    var timestamptemp = 0;


    function animateMarker(timestamp) {
        // Update the data to a new position based on the animation timestamp. The
        // divisor in the expression `timestamp / 1000` controls the animation speed.

/*
        if(timestamp != 0)
        {
            if(flag == 0)
            {
                timestamptemp = timestamp;
                flag = 1;
            }
            else{
                //map.getSource('point').setData(pointMove(x1,y1 + (timestamp - timestamptemp)/1000*0.00001));
                if(timestamp - timestamptemp < 1000)
                {
                    map.getSource('point').setData(pointMove(x1+(timestamp - timestamptemp)/1000*(x-x1),y1+(timestamp - timestamptemp)/1000*(y-y1)));
                }
            }
        }
*/

        if(map.getSource('point')!=undefined){
            map.getSource('point').setData(pointMove(x,y));            
        }
        else{
            if(map!=undefined){
                map.addSource('point', {
                    "type": "geojson",
                    "data": pointMove(x,y)
                });

                map.addLayer({
                    "id": "point",
                    "source": "point",
                    "type": "circle",
                    "paint": {
                        "circle-radius": 10,
                        "circle-color": "#007cbf"
                    }
                });                
            }
            else{
                console.warn("Map is not defined")
            }

        }

        // Request the next frame of the animation.
        //requestAnimationFrame(animateMarker);

    }

    var timer = setInterval(function(){
        polling(animateMarker);
    },1100);//polling interval>1.03s



    // Start the animation.
    //animateMarker(0);

//     document.getElementById('button-fr').addEventListener('click', function(event) {
//     //alert('djg');
//     animateMarker(0);
// });
});





var changeMap=function(n){
    var map = new mapboxgl.Map(mapinfo[1]);
    x=null;
    y=null;
}
</script>

</body>
</html>